# yolo11n_pd.yaml
# Ultralytics-style model spec for YOLO11n-PD
# Save under: yolo11n-pd/models/yolo11n_pd.yaml
# NOTE: This spec references custom layer names (BOTBlock, LSKA, C3k2Ghost, LSCDHead).
# Make sure the loader that reads this YAML knows how to instantiate those classes
# (we implemented them as models/bot.py, models/lska.py, models/c3k2_ghost.py, models/lscd_head.py).

# number of classes
nc: 4

# anchors (not used for anchor-free head, but kept for compatibility)
anchors:
  - [10,13, 16,30, 33,23]
  - [30,61, 62,45, 59,119]
  - [116,90, 156,198, 373,326]

# 'backbone' defines feature-extracting layers (top -> bottom)
# each entry: [from, number, module, args]
backbone:
  # stem
  - [ -1, 1, Conv, [3, 64, 3, 2] ]            # conv 3x3 stride2 -> 320x320x64
  - [ -1, 1, C3k2Ghost, [64, 64, 1, 0.5] ]    # shallow C3-like Ghost block

  # downsample blocks
  - [ -1, 1, Conv, [64, 128, 3, 2] ]          # down -> 160
  - [ -1, 1, C3k2Ghost, [128, 128, 1, 0.5] ]  # stage

  - [ -1, 1, Conv, [128, 256, 3, 2] ]         # down -> 80 (P3)
  - [ -1, 1, C3k2Ghost, [256, 256, 1, 0.5] ]

  - [ -1, 1, Conv, [256, 512, 3, 2] ]         # down -> 40 (P4)
  - [ -1, 1, C3k2Ghost, [512, 512, 1, 0.5] ]

  - [ -1, 1, Conv, [512, 512, 3, 2] ]         # down -> 20 (P5)
  - [ -1, 1, C3k2Ghost, [512, 512, 1, 0.5] ]

  # SPPF-like block (we used a lightweight stack in code)
  - [ -1, 1, SPPF, [512, 5] ]                 # enlarge receptive field

  # PD modules at deepest level
  - [ -1, 1, BOTBlock, [512, 4, 1.0] ]        # BOTBlock(channels, heads, expansion)
  - [ -1, 1, LSKA, [512, 3, 21, 7] ]          # LSKA(channels, num_splits, large_kernel, mid_kernel)

# 'head' defines the neck + detection head
head:
  # refine P5
  - [ -1, 1, C3k2Ghost, [512, 512, 1, 0.5] ]  # p5 refine
  # upsample and concat with P4 (loader should handle concat semantics based on `from` indices)
  - [ -1, 1, Upsample, [2] ]
  - [ -2, 1, Concat, [ -1, -3 ] ]             # concat p5_up with p4 (indexing depends on loader)
  - [ -1, 1, LSKA, [1024, 3, 21, 7] ]         # LSKA on fused 1024-ch map
  - [ -1, 1, C3k2Ghost, [1024, 512, 1, 0.5] ] # fuse -> 512 (p4_out)

  # upsample and concat with P3
  - [ -1, 1, Upsample, [2] ]
  - [ -2, 1, Concat, [ -1, -5 ] ]             # concat p4_up with p3
  - [ -1, 1, LSKA, [768, 3, 21, 7] ]          # LSKA on fused 768-ch map
  - [ -1, 1, C3k2Ghost, [768, 256, 1, 0.5] ]  # fuse -> 256 (p3_out)

  # expand p5 for head (simulate channel growth)
  - [ -6, 1, Conv, [512, 1024, 1, 1] ]        # project p5 -> 1024

  # final head: provide the three feature maps in order P3, P4, P5 to LSCDHead
  - [ -3, 1, LSCDHead, [[256,512,1024], 4, 256, False] ]  # LSCDHead(in_channels_list, nc, shared_c, use_aux_conv)

# model metadata
names: ["D00","D10","D20","D40"]   # class names for RDD2022
